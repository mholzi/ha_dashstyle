# Copilot Instructions for HA Dashstyle

This document provides guidance for GitHub Copilot when working with the HA Dashstyle custom Home Assistant integration.

## Project Overview

HA Dashstyle is a custom Home Assistant integration that provides:
- A fully configurable dashboard for larger Home Assistant setups
- Floor-based room organization (EG, OG, Keller, Außenbereich)
- Native implementation without dependency on HACS cards
- Admin configuration interface
- Entity classification system
- Theme customization capabilities

## Architecture

### Backend (Python)
- **Integration Entry Point**: `__init__.py` - Handles setup and panel registration
- **Configuration Flow**: `config_flow.py` - User setup wizard
- **Constants**: `const.py` - Floor definitions, entity types, default themes
- **API Layer**: `api.py` - REST endpoints for frontend communication

### Frontend (Native Web)
- **HTML Structure**: `frontend/index.html` - Dashboard layout and admin panel
- **Styling**: `frontend/style.css` - Responsive CSS with CSS custom properties
- **JavaScript Logic**: `frontend/app.js` - Dashboard functionality and API communication

## Key Design Principles

1. **No External Dependencies**: Must not rely on HACS cards or custom resources
2. **Native Web Technologies**: Use only HTML, CSS, and vanilla JavaScript
3. **Responsive Design**: Support both desktop and mobile interfaces
4. **Admin Security**: Configuration only accessible to HA administrators
5. **Entity Auto-Discovery**: Automatically detect entities based on naming patterns

## Entity Organization

### Floor Structure
```python
FLOORS = {
    "EG": ["wohnzimmer", "buero", "kueche", "eingangsflur", "gaesteklo", "treppe_erdgeschoss"],
    "OG": ["kids", "kinderbad", "flur", "aupair", "schlafzimmer"],
    "Keller": ["partykeller", "heizungskeller", "kellerflur", "waschkeller", "serverraum", "buero_keller", "sauna"],
    "Außen": ["aussen"]
}
```

### Entity Types
- hoover (robot vacuums)
- temperature (sensors and thermostats)
- humidity, motion, door, window
- light, switch, cover, climate
- media, security

## API Patterns

### Authentication
```python
user: User = request.get("hass_user")
if not user or not user.is_admin:
    return self.json_message("Admin access required", 403)
```

### Entity Detection
```python
def _get_room_entities(self, hass: HomeAssistant, room_name: str) -> list[str]:
    entities = []
    for entity_id in hass.states.all():
        if room_name in entity_id.entity_id:
            entities.append(entity_id.entity_id)
    return entities
```

## Frontend Patterns

### State Management
```javascript
class HADashstyle {
    constructor() {
        this.currentFloor = 'EG';
        this.adminMode = false;
        this.config = this.loadConfiguration();
    }
}
```

### API Communication
```javascript
async loadRooms() {
    const response = await fetch(`/api/ha_dashstyle/rooms/${this.currentFloor}`, {
        headers: {
            'Authorization': `Bearer ${this.getAccessToken()}`,
        }
    });
    const rooms = await response.json();
}
```

### Theme Application
```javascript
updateThemeColor(property, value) {
    document.documentElement.style.setProperty(property, value);
    this.config.theme[property] = value;
    this.saveConfiguration();
}
```

## CSS Architecture

### Custom Properties
```css
:root {
    --primary-color: #1976d2;
    --accent-color: #ff9800;
    --background-color: #fafafa;
    --card-background-color: #ffffff;
    --transition: all 0.3s ease;
}
```

### Component Structure
- `.dashboard-container` - Main layout container
- `.room-card` - Individual room representation
- `.admin-panel` - Configuration overlay
- `.floor-tabs` - Navigation between floors

## Common Patterns

### Entity State Checking
```python
def _is_entity_active(self, hass: HomeAssistant, entity_id: str) -> bool:
    state = hass.states.get(entity_id)
    active_states = ["on", "open", "active", "playing", "home", "heat", "cool"]
    return state.state.lower() in active_states
```

### Room Card Creation
```javascript
createRoomCard(room) {
    const card = document.createElement('div');
    card.className = 'room-card';
    card.innerHTML = `
        <div class="room-header">
            <span class="room-name">${room.name}</span>
            <span class="room-icon">${room.icon}</span>
        </div>
        <!-- Additional room content -->
    `;
    return card;
}
```

### Configuration Persistence
```javascript
saveConfiguration() {
    localStorage.setItem('ha_dashstyle_config', JSON.stringify(this.config));
}

loadConfiguration() {
    const saved = localStorage.getItem('ha_dashstyle_config');
    return saved ? JSON.parse(saved) : defaultConfig;
}
```

## Testing Considerations

### Backend Testing
- Test API endpoints with admin and non-admin users
- Verify entity detection logic with various naming patterns
- Check configuration flow with different user inputs

### Frontend Testing
- Test responsive design on different screen sizes
- Verify admin panel accessibility and functionality
- Test theme changes and persistence
- Check entity control functionality

## Security Guidelines

1. **Admin Verification**: Always check user.is_admin for configuration endpoints
2. **Input Validation**: Validate all user inputs in config flow and API
3. **Entity Access**: Ensure users can only control entities they have access to
4. **XSS Prevention**: Sanitize any user-provided content displayed in frontend

## Performance Considerations

1. **Entity Limiting**: Limit entity queries to prevent performance issues
2. **Caching**: Cache configuration and entity lists where appropriate
3. **Lazy Loading**: Load room data only when floors are selected
4. **Debounced Updates**: Debounce theme changes and configuration saves

## Error Handling

### Python
```python
try:
    # API operation
    pass
except Exception as err:
    _LOGGER.error("Error in operation: %s", err)
    return self.json_message("Error message", 500)
```

### JavaScript
```javascript
try {
    const response = await fetch('/api/endpoint');
    const data = await response.json();
} catch (error) {
    console.error('API call failed:', error);
    // Show user-friendly error message
}
```

## Extension Points

When extending the integration:

1. **New Entity Types**: Add to SENSOR_TYPES in const.py
2. **Additional Floors**: Extend FLOORS configuration
3. **New Themes**: Add theme presets to DEFAULT_THEME
4. **Custom Cards**: Create new room card types in frontend
5. **Additional APIs**: Add new view classes in api.py

## Debugging

### Backend Debugging
- Check Home Assistant logs for Python errors
- Use `_LOGGER.debug()` for development debugging
- Test API endpoints directly with curl or browser dev tools

### Frontend Debugging
- Use browser developer console for JavaScript errors
- Check Network tab for API call failures
- Use `console.log()` for development debugging
- Test with different user permission levels

## Version Management

- Follow semantic versioning (MAJOR.MINOR.PATCH)
- Update manifest.json version on releases
- Maintain backward compatibility for configuration
- Document breaking changes in README changelog